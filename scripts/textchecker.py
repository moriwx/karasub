import difflib
import os
import re
import webbrowser

def create_char_level_html_diff(text1, text2, filename="check_result.html"):
    """创建字符级别的HTML差异比较文件"""
    
    # 使用difflib进行字符级别比较
    differ = difflib.Differ()
    diff = list(differ.compare(text1, text2))
    
    # 构建HTML内容
    html_content = []
    html_content.append('''<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>文本校对结果</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 20px;
            background-color: #f9f9f9;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .legend {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .diff-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .text-block {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.8;
        }
        .char {
            padding: 1px 2px;
            border-radius: 2px;
            margin: 0 1px;
        }
        .deleted {
            background-color: #ffcccc;
            /* text-decoration: line-through; */
            color: #cc0000;
        }
        .added {
            background-color: #ccffcc;
            color: #006600;
        }
        .unchanged {
            /* 默认样式，无特殊标记 */
        }
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4f8;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>文本校对结果</h1>
        <div class="diff-container">
            <div class="text-block" id="combined-diff">''')
    
    # 构建合并的差异显示
    for item in diff:
        char = item[2:]  # 获取字符
        if item.startswith('- '):
            # 被删除的字符
            html_content.append(f'<span class="char deleted">{char}</span>')
        elif item.startswith('+ '):
            # 新增的字符
            html_content.append(f'<span class="char added">{char}</span>')
        elif item.startswith('  '):
            # 相同的字符
            html_content.append(f'<span class="char unchanged">{char}</span>')
    
    html_content.append('''</div>
        </div>
        <div class="summary">
            <h3>差异统计:</h3>
            <p>文本1长度: ''' + str(len(text1)) + ''' 字符</p>
            <p>文本2长度: ''' + str(len(text2)) + ''' 字符</p>
            <p>总差异数: ''' + str(len([d for d in diff if d.startswith(('- ', '+ '))])) + '''</p>
            <p>生成时间: ''' + __import__('datetime').datetime.now().strftime("%Y-%m-%d %H:%M:%S") + '''</p>
        </div>
        <div class="legend">
            <h3>图例说明:</h3>
            <p><span class="char deleted">红色背景</span> - 在文本1中存在但在文本2中被删除的字符</p>
            <p><span class="char added">绿色背景</span> - 在文本2中新增的字符</p>
            <p>无标记 - 两个文本中相同的字符</p>
        </div>
    </div>
</body>
</html>''')
    
    # 写入文件
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(''.join(html_content))
    
    return filename


if __name__=='__main__':
    a = '''
[00:07:17]風[00:07:81]を[00:08:12]置[00:08:27]い[00:08:43]て[00:09:43]
[00:09:68]雨[00:10:23]を[00:10:53]抜[00:10:66]け[00:10:82]て[00:11:68] 
[00:12:03]咲[00:12:33]き[00:12:65]誇[00:13:33]れ[00:15:22]

[00:16:61]●●●●[00:25:49]
[00:25:62]あぁ[00:25:85] [00:26:02]夜[00:26:37]風[00:26:53]に[00:26:68]揺[00:26:84]ら[00:26:99]れ[00:27:15]い[00:27:29]る[00:27:59]
[00:27:70]折[00:27:86]れ[00:28:00]な[00:28:15]い[00:28:33]よ[00:28:49]う[00:28:66]に[00:28:81] [00:28:97]怯[00:29:29]え[00:29:58]て[00:29:69]い[00:29:80]る[00:30:03]

[00:30:21]ず[00:30:35]っ[00:30:49]と[00:30:79] [00:30:93]雨[00:31:24]に[00:31:40]濡[00:31:55]ら[00:31:70]さ[00:31:84]れ[00:32:00]て[00:32:11]い[00:32:24]る[00:32:50]
[00:32:65]ま[00:32:77]た[00:32:92]ど[00:33:06]う[00:33:21]し[00:33:32]た[00:33:59]っ[00:33:75]て[00:33:87]

[00:33:92]凍[00:34:23]え[00:34:40]て[00:34:55]し[00:34:69]ま[00:34:82]っ[00:34:93]た[00:35:13]ん[00:35:29]だ[00:36:02]
[00:36:30]誰[00:36:58]か[00:36:97]こ[00:37:25]の[00:37:36]声[00:37:64]に[00:37:81]応[00:38:23]答[00:38:60]し[00:38:70]て[00:39:70]

[00:39:94]痛[00:40:21]が[00:40:35]る[00:40:52]ば[00:40:73]っ[00:41:08]か[00:41:26]て[00:41:61] 
[00:42:35]咲[00:42:44]け[00:42:62]な[00:42:76]い[00:43:02]ま[00:43:12]ま[00:43:36]の[00:43:70]ハー[00:44:06]ト[00:44:17]を[00:44:40]

[00:45:09]あぁ[00:45:62] [00:46:01]今[00:46:62] [00:47:22]見[00:47:39]逃[00:47:86]せ[00:48:06]な[00:48:16]い[00:48:35]く[00:48:45]ら[00:48:83]い[00:48:98]
[00:49:04]綺[00:49:25]麗[00:49:61]に[00:49:84]咲[00:50:38]か[00:50:86]せ[00:51:38]た[00:51:65]い[00:51:89]ん[00:52:08]だ[00:53:67]

[00:54:75]光[00:55:08]っ[00:55:19]て[00:55:45]い[00:55:56]た[00:55:73]未[00:56:01]来[00:56:33]が[00:56:63]ず[00:56:79]っ[00:56:98]と[00:57:11]
[00:57:27]待[00:57:41]っ[00:57:57]て[00:57:72]い[00:57:89]た[00:58:17]世[00:58:48]界[00:58:77]が[00:58:95] 
[00:59:15]煌[00:59:71]め[00:59:99]く[01:00:16]音[01:00:61]の[01:00:91]中[01:01:55]に[01:01:82]あ[01:02:13]る[01:02:63]な[01:02:79]ら[01:03:33]

[01:03:98]最[01:04:26]低[01:04:58]で[01:04:90]最[01:05:19]悪[01:05:49]な[01:05:66]涙[01:06:09]も[01:06:22]
[01:06:69]痛[01:07:00]が[01:07:14]り[01:07:31]で[01:07:47]嫌[01:07:79]い[01:07:94]な[01:08:24]声[01:08:53]も[01:08:81]
[01:09:10]連[01:09:28]れ[01:09:42]て[01:09:72]行[01:10:04]き[01:10:32]た[01:10:67]い[01:10:81]ん[01:10:98]だ[01:11:29]全[01:11:61]部[01:13:02]

[01:14:16]不[01:14:31]完[01:14:66]全[01:14:97]な[01:15:23]毎[01:15:57]日[01:15:86]が[01:15:98]
[01:16:13]一[01:16:46]瞬[01:16:76]の[01:17:09]カ[01:17:39]ケ[01:17:71]ラ[01:17:99]達[01:18:28]が[01:18:41]
[01:18:60]重[01:19:14]な[01:19:27]っ[01:19:46]て[01:19:76]こ[01:19:89]ん[01:20:10]な[01:20:38]歌[01:20:71]を[01:21:05]奏[01:21:63]で[01:22:11]た[01:22:27]ら[01:23:12]

[01:23:46]そ[01:23:61]れ[01:23:77]は[01:24:09]
[01:24:38]言[01:24:99]葉[01:25:27]だ[01:25:54]け[01:25:88]じゃ[01:26:18]届[01:26:77]か[01:27:13]な[01:27:39]い[01:27:58]距[01:27:87]離[01:28:04]を[01:28:18]

[01:28:35]き[01:28:62]っ[01:28:71]と[01:28:94]
[01:29:25]飛[01:29:55]び[01:29:82]越[01:30:13]え[01:30:44]て[01:30:75]結[01:31:06]ぶ[01:32:25]

[01:33:22]き[01:33:37]っ[01:33:55]と[01:33:82]
[01:34:11]輪[01:34:38]を[01:34:66]描[01:35:34]い[01:35:63]て[01:35:98]い[01:36:15]く[01:38:00]

[01:45:11]さぁ[01:45:41] [01:45:49]涙[01:45:88]を[01:46:04]拭[01:46:14]い[01:46:26]て[01:46:41] [01:46:48]喉[01:46:92]を[01:47:07]鳴[01:47:23]ら[01:47:31]し[01:47:40]て[01:47:58] 
[01:47:66]心[01:48:02]臓[01:48:29]が[01:48:45]ペー[01:48:74]ス[01:48:81]アー[01:48:88]プ[01:48:95]し[01:49:04]て[01:49:15]い[01:49:29]く[01:49:41]

[01:49:53]怖[01:49:70]が[01:49:78]ら[01:49:86]な[01:49:94]い[01:50:04]で[01:50:13] [01:50:17]乗[01:50:25]っ[01:50:33]て[01:50:41]け[01:50:52]飛[01:50:60]ん[01:50:68]で[01:50:76]浮[01:50:84]い[01:50:95]て[01:51:15]
[01:51:36]ペ[01:51:52]ロ[01:51:64]を[01:51:81]回[01:52:10]し[01:52:20]て[01:52:39] [01:52:57]グ[01:52:69]ル[01:52:85]ヴ[01:53:08]と[01:53:21]ラ[01:53:37]ン[01:53:57]デ[01:53:75]ヴー[01:53:96]し[01:54:03]て[01:54:12]い[01:54:19]く[01:54:34]

[01:54:50]こ[01:54:55]ん[01:54:61]が[01:54:69]ら[01:54:77]が[01:54:85]っ[01:54:94]ちゃ[01:55:02]つ[01:55:10]ま[01:55:17]ん[01:55:24]な[01:55:32]い[01:55:78]も[01:55:82]ん[01:55:89]ね[01:56:03]
[01:56:23]迷[01:56:49]っ[01:56:66]た[01:56:83]ら[01:56:98]踊[01:57:23]れ[01:57:37] [01:57:53]時[01:57:77]代[01:58:04]は[01:58:20]セ[01:58:34]ン[01:58:51]せー[01:58:65]ショ[01:58:81]ナ[01:59:03]ル[01:59:20]

[01:59:31]お[01:59:41]構[01:59:76]い[01:59:78]な[01:59:81]し[01:59:87]の[02:00:11]稲[02:00:36]妻[02:00:62]泣[02:00:78]い[02:00:87]て[02:01:03]
[02:01:10]声[02:01:53]を[02:01:69]嗄[02:01:78]ら[02:01:88]し[02:01:96]て[02:02:14]

[02:02:31]泥[02:02:78]だ[02:02:91]ら[02:03:06]け[02:03:20]に[02:03:51]な[02:03:63]っ[02:03:80]て[02:03:96]も[02:04:07]
[02:04:17]生[02:04:41]き[02:04:57]て[02:04:99]い[02:05:37]き[02:05:64]た[02:05:75]い[02:06:19]

[02:06:43]今[02:06:75]夜[02:06:94] [02:07:21]あ[02:07:35]の[02:07:52]空[02:07:80]で[02:07:98]合[02:08:46]流[02:08:81]し[02:08:93]て[02:09:81]
[02:10:16]朝[02:10:40]が[02:10:55]満[02:10:71]た[02:11:11]す[02:11:23]ま[02:11:39]で[02:12:21]

[02:12:49]そ[02:12:65]れ[02:12:81]ぞ[02:13:12]れ[02:13:23]の[02:13:36]星[02:13:68]を[02:13:87]探[02:14:32]そ[02:14:43]う[02:14:70]
[02:15:38]ね[02:15:46]え[02:16:06]、[02:16:34]今[02:17:34]同[02:17:68]じ[02:18:04]事[02:18:47]を[02:18:58]

[02:18:80]思[02:19:11]っ[02:19:20]て[02:19:35]い[02:19:44]た[02:19:62]ん[02:19:74]だ[02:19:94]っ[02:20:12]て[02:20:56]
[02:21:09]ほ[02:21:23]ら[02:21:67] [02:22:14]話[02:22:42]さ[02:22:57]な[02:22:83]く[02:22:94]て[02:23:06]も[02:23:30]分[02:23:43]か[02:23:63]り[02:23:95]合[02:24:11]え[02:24:24]た[02:24:44]

[02:25:04]あぁ[02:25:59] [02:25:88]あぁ[02:26:84]
[02:27:13]こ[02:27:28]ん[02:27:44]な[02:27:76]嬉[02:28:08]し[02:28:49]さ[02:28:82]を[02:29:13]ず[02:29:28]っ[02:29:46]と[02:29:64]
[02:29:84]歌[02:30:30]っ[02:30:48]て[02:30:81]み[02:31:26]た[02:31:70]か[02:31:87]っ[02:32:02]た[02:33:66]

[02:34:70]光[02:35:05]っ[02:35:18]て[02:35:35]い[02:35:51]た[02:35:66]未[02:35:96]来[02:36:27]が[02:36:57]ず[02:36:72]っ[02:36:89]と[02:37:02]
[02:37:18]待[02:37:33]っ[02:37:48]て[02:37:63]い[02:37:79]た[02:38:12]世[02:38:40]界[02:38:71]が[02:38:83]
[02:39:02]煌[02:39:62]め[02:39:91]い[02:40:00]て[02:40:26]目[02:40:54]の[02:40:83]前[02:41:43]に[02:41:75]あ[02:42:04]る[02:42:54]か[02:42:70]ら[02:43:49]

[02:43:86]瞬[02:44:75]き[02:45:08]の[02:45:41]刹[02:45:72]那[02:45:87]ま[02:46:02]で[02:46:27]
[02:46:60]こ[02:46:75]の[02:46:92]ス[02:47:04]トー[02:47:26]リー[02:47:52]の[02:47:81]最[02:48:14]後[02:48:29]ま[02:48:46]で[02:48:70]
[02:49:04]輝[02:49:64]く[02:49:95]花[02:50:55]で[02:50:89]い[02:51:20]た[02:51:35]い[02:51:51]な[02:52:76]

[02:54:17]不[02:54:27]完[02:54:59]全[02:54:88]な[02:55:01]私[02:55:25]達[02:55:71]が[02:55:87]
[02:56:02]一[02:56:32]瞬[02:56:63]の[02:56:96]カ[02:57:29]ケ[02:57:59]ラ[02:57:90]達[02:58:17]が[02:58:32]
[02:58:50]重[02:59:08]な[02:59:22]っ[02:59:40]て[02:59:68]こ[02:59:79]ん[03:00:03]な[03:00:27]歌[03:00:60]を[03:00:93]奏[03:01:51]で[03:02:02]た[03:02:18]ら[03:03:01]

[03:03:34]そ[03:03:50]れ[03:03:67]は[03:03:92]
[03:04:25]夢[03:04:85]見[03:05:14]る[03:05:49]だ[03:05:80]け[03:06:10]じゃ[03:06:25]叶[03:06:72]わ[03:07:01]な[03:07:31]い[03:07:42]想[03:07:76]い[03:07:94]を[03:08:07]

[03:08:22]ず[03:08:37]っ[03:08:55]と[03:08:82]
[03:09:13]新[03:10:06]し[03:10:35]く[03:10:60]し[03:10:66]て[03:10:83]い[03:11:00]く[03:12:31]

[03:13:08]ず[03:13:20]っ[03:13:38]と[03:13:68] 
[03:14:00]追[03:14:32]い[03:14:60]掛[03:14:92]け[03:15:23]て[03:15:54]い[03:15:87]こ[03:15:96]う[03:17:63]

[03:17:15]風[03:17:69]を[03:18:02]置[03:18:14]い[03:18:31]て[03:19:17]
[03:19:47]雨[03:20:08]を[03:20:42]抜[03:20:56]け[03:20:75]て[03:21:58]

[03:21:92]咲[03:22:24]き[03:22:56]誇[03:23:27]れ[03:24:18]
[03:24:42]満[03:24:70]天[03:24:97]の[03:25:30]空[03:25:60]へ[03:27:71]

'''

    b = '''風を置いて 雨を抜けて 咲き誇れ

あぁ 夜風に揺られている

折れないように怯えている

ずっと雨に濡らされている

またどうしたって

凍えてしまったんだ

誰かこの声に応答して

痛がるばっかで

咲けないままのハートを

あぁ今 見逃せないくらい綺麗に

咲かせたいんだ

光っていた未来が

ずっと待っていた世界が

きらめく音の中にあるなら

最低で最悪な涙も

痛がりで嫌いな声も

連れていきたいんだ全部

不完全な毎日が

一瞬のカケラたちが重なって

こんな歌を奏でたら

それは

言葉だけじゃ届かない距離を

きっと飛び越えて結ぶ

きっと輪を描いていく

さぁ涙を拭いて 喉を鳴らして

心臓がペースアップしていく

怖がらないでノッてけ

飛んで浮いて

ベロを回して

グルーヴとランデヴしていく

こんがらがっちゃ

つまんないもんね

迷ったら踊れ

時代はセンセーショナル

御構い無しのイナズマ

泣いて声を嗄らして

泥だらけになっても生きていたい

今夜あの空で合流して

朝が満たすまで

それぞれの星を探そう

ねぇ今

同じことを思っていたんだって

ほら話さなくても分かり合えた

あぁ あぁ こんな嬉しさをずっと

歌ってみたかった

光っていた未来が

ずっと待っていた世界が

きらめいて目の前にあるから

瞬きの刹那まで

この物語の最後まで

輝く花でいたいんだ

不完全な私たちが

一瞬のカケラたちが重なって

こんな歌を奏でたら

それは

夢見るだけじゃ叶わない想いを

ずっと新しくしていく

ずっと追いかけていこう

風を置いて 雨を抜けて 咲き誇れ

満天の空へ'''

    a = re.sub(r"【\S+】", "", a)
    a = re.sub(r"\[(\d+:\d+:\d+)\]", "", a)
    filename = create_char_level_html_diff(a, b)

    try:
        file_path = os.path.abspath(filename)
        print(f"正在打开: {file_path}")
        webbrowser.open('file://' + file_path)
        print("已在默认浏览器中打开结果文件")
    except Exception as e:
        print(f"自动打开失败，请手动打开文件: {filename}")
        print(f"错误信息: {e}")